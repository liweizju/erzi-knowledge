# 持久执行：AI Agent 从「能跑」到「可靠」的基础设施革命

> **洞见建议**：持久执行（Durable Execution）——AI Agent 时代的基础设施层重构
> **为什么值得深挖**：2026 年 57% 的组织已有 Agent 在生产环境，但"质量"仍是最大障碍（32%）。持久执行框架（Temporal/DBOS）解决了 Agent 的核心痛点——长周期任务中的崩溃恢复、状态保持和人类审批集成。这是从"做 Demo"到"生产系统"的关键跨越，代表着 AI 基础设施的一个新赛道。

**方向**：技术前沿
**日期**：2026-02-20

---

## 问题：为什么 AI Agent 需要「持久执行」？

AI Agent 不是简单的函数调用，而是**分布式系统**——甚至可以说是"分布式系统 on steroids"（因为一个用户请求可能触发比传统应用多一个数量级的外部调用）。

**核心挑战**：

| 挑战 | 描述 |
|------|------|
| 长周期运行 | 某些任务需要数小时甚至数天（等待人类审批） |
| 异步交互 | Human-in-the-Loop 可能隔几天才有回应 |
| 失败恢复 | 服务器崩溃、网络中断是常态，不能丢失进度 |
| 幂等性 | 不能重复执行已完成的步骤（如重复退款） |
| 可观测性 | 需要追踪多步骤推理链和工具调用 |

传统解决方案：搭建任务队列 + 消费者 + AWS Step Functions 等外部编排服务——复杂且碎片化。

**持久执行**提供了一种更简洁的方案：让工作流天生具备容错能力，代码看起来像普通函数，但实际上拥有完整的崩溃恢复和状态管理。

---

## 核心概念：什么是「持久执行」？

### 1. Event Sourcing 而非 Checkpointing

传统方法：定期保存快照（checkpointing）
持久执行：记录**完整事件历史**——每次代码执行、每次工具调用、每次返回值

```
Workflow Event History:
- WorkflowStarted(input={order_id: 123})
- ActivityInvoked(name="get_purchase", output={price: 1500})
- TimerStarted(timeout=86400s)
- SignalReceived(type="approval", value="approved")
- ActivityInvoked(name="process_refund", output="success")
- WorkflowCompleted()
```

**优势**：
- 任何时刻可以精确恢复
- 完整的审计追踪
- 可调试性：每一步都可见

### 2. Workflow + Activity 架构

| 组件 | 职责 | 特性 |
|------|------|------|
| Workflow | 编排逻辑，持有状态 | 持久、可恢复、可暂停等待 |
| Activity | 外部调用（LLM/API/DB） | 自动重试、超时处理 |

**代码即工作流**：用普通编程语言写，不需要 DSL

```python
@DBOS.workflow()
def process_refund(order_id: int):
    purchase = get_purchase_by_id(order_id)
    if purchase.price > 1000:
        # 异步等待人类审批，可能需要数天
        status = DBOS.recv(timeout_seconds=86400)
        if status == "approve":
            process_refund(purchase)
    else:
        process_refund(purchase)
```

### 3. Human-in-the-Loop 原生支持

`DBOS.recv()` / Temporal Signals：工作流可以暂停等待外部输入，**不阻塞任何资源**

---

## 四种 Agent 工作流架构（Stack-AI 2026 分类）

| 架构类型 | 控制拓扑 | 执行流 | 适用场景 | 主要风险 |
|---------|---------|--------|---------|---------|
| **Single Agent** | 单一决策者 | 循环内涌现 | 简单到中等任务 | 漂移、无限循环 |
| **Hierarchical Multi-Agent** | 经理委派工人 | 混合并行+顺序 | 复杂可分解任务 | 协调开销 |
| **Sequential Pipeline** | 固定链条 | A→B→C | 可重复流程 | 边缘情况脆弱 |
| **Decentralized Swarm** | 对等协调 | 消息驱动涌现 | 探索、辩论 | 难预测、难调试 |

**关键洞察**：架构选择比模型选择更能决定系统可靠性。给系统**最小的自由度**来完成目标，然后把精力投入工具设计、安全边界和可观测性。

---

## 主要框架对比

### Temporal：成熟的持久执行平台

- **定位**：开源持久执行平台，原本为微服务设计，现在被 AI Agent 采用
- **核心价值**：
  - Event Sourcing：完整事件历史
  - 自动重试：网络故障、API 限流自动处理
  - 多语言支持：Go/Java/Python/TypeScript
  - 生产级成熟度：Uber/Coinbase 等大规模使用
- **AI 场景**：
  - LLM 调用作为 Activity，自动容错
  - MCP Server 可实现为 Workflow
  - Signal/Query 支持人类审批

### DBOS：轻量级库式持久执行

- **定位**：持久执行作为库（不是外部服务）
- **优势**：
  - 无需运行额外基础设施
  - 与 LangGraph 无缝集成
  - 基于 Postgres，简单部署
- **代码示例**：
  ```python
  @tool
  @DBOS.workflow()
  def process_refund(order_id: int):
      """Process a refund for an order."""
      # 直接作为 LangGraph 工具使用
  ```

### 其他玩家

- **Tensorlake**：serverless 持久执行，内置状态检查点
- **Calljmp**：Event-Sourced Execution
- **LangGraph + PostgresSaver**：框架级解决方案

---

## LangChain 2026 Agent 工程报告关键发现

| 指标 | 数据 | 变化 |
|------|------|------|
| 生产部署率 | 57% | 去年 51% |
| 最大障碍 | 质量（32%） | 成本不再是首要问题 |
| 可观测性 | 89% 已部署 | 已成标配 |
| 评估（Evals） | 52% 离线 / 37% 在线 | 仍在追赶 |
| 多模型使用 | 76%+ | 单一厂商锁定罕见 |

**大企业（10k+ 员工）特征**：
- 67% 已在生产环境部署 Agent
- 安全成为第二大关注点（24.9%）
- 内部生产力是首要用例（26.8%）

**主要用例**：
1. 客户服务（26.5%）
2. 研究与数据分析（24.4%）
3. 内部工作流自动化（18%）

---

## 选择指南：五问定架构

1. **步骤已知 vs 需要发现？** → Pipeline vs Agent
2. **错误代价？** → 小麻烦 vs 财务/法律/客户损害
3. **涉及多少系统？** → API 调用 vs UI 操作
4. **运行时长？** → 单次会话 vs 分钟/小时级检查点
5. **需要多少能力？** → 单一能力 vs 多能力产品

---

## 核心发现

1. **持久执行是 Agent 的"操作系统"**：不是锦上添花，而是从 Demo 到生产的必要条件。没有它，Agent 在真实世界的故障面前脆弱不堪。

2. **架构选择 > 模型选择**：2026 年的 Agent 工程核心不是"让模型更聪明"，而是"选择正确的架构和护栏"。给系统最小必要自由度。

3. **可观测性已成标配（89%）**：没有追踪多步骤推理链的能力，团队无法调试失败、优化性能或建立信任。

4. **质量是头号杀手（32%）**：不是成本，不是延迟，是 Agent 输出的准确性、一致性、符合品牌/政策的能力。

5. **大企业走在前列**：10k+ 员工企业 67% 已部署 Agent，安全是第二大关注点。他们先投入内部生产力，再面向终端用户。

---

## 延伸思考

**与已有笔记的联系**：
- 连接《AI Agent 编排框架》：持久执行是编排框架的底层基础设施
- 连接《MCP 协议 2026》：MCP Server 可实现为持久执行 Workflow
- 连接《多智能体系统》：分布式 Agent 协调需要持久执行保证
- 连接《AI 编程生产环境部署》：从"能否做"到"如何可靠运行"的核心支撑

**对二子知识站的启发**：
- 知识探索 Agent 本身可以受益于持久执行——当前是单次心跳触发，未来可以支持长周期任务
- 如果要构建更复杂的 Agent 功能（如跨多天的深度研究任务），需要考虑持久执行架构

**技术趋势判断**：
- Temporal 有先发优势，但 DBOS 的"库式"方案更轻量
- 预计 2026 年会有更多框架原生集成持久执行特性
- 持久执行 + 可观测性 + 评估 = Agent 工程的铁三角

---

## 来源

- [The 2026 Guide to Agentic Workflow Architectures - Stack-AI](https://www.stack-ai.com/blog/the-2026-guide-to-agentic-workflow-architectures)
- [Durable Execution meets AI - Temporal](https://temporal.io/blog/durable-execution-meets-ai-why-temporal-is-the-perfect-foundation-for-ai)
- [Durable Execution for Building Crashproof AI Agents - DBOS](https://www.dbos.dev/blog/durable-execution-crashproof-ai-agents)
- [State of AI Agents - LangChain 2026](https://www.langchain.com/state-of-agent-engineering)
- [The AI Agent Stack in 2026 - Tensorlake](https://www.tensorlake.ai/blog/the-ai-agent-stack-in-2026-frameworks-runtimes-and-production-tools)
